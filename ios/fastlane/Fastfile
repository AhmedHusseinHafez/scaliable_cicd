# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

  $keychain_name = SecureRandom.uuid
  $keychain_password = SecureRandom.hex(100)

  after_all do |lane, options|
      remove_keychain
  end

  error do |lane, exception, options|
      remove_keychain
  end

  desc "Remove Keychain from CI"
  private_lane :remove_keychain do |options|
      if $is_ci
          if File.exist?(File.expand_path("~/Library/Keychains/#{$keychain_name}-db"))
              UI.important "Deleting keychain #{$keychain_name}"
              delete_keychain(name: $keychain_name)
          else
              UI.important "No keychain file found to delete"
          end
      end
  end

    desc "Setup Keychain for match on CI"
    private_lane :setup_keychain do |options|
        create_keychain(
            name: $keychain_name,
            password: $keychain_password,
            default_keychain: true,
            unlock: true,
            timeout: 0,
            lock_when_sleeps: false
        )
    end

  desc "Push a new beta build to TestFlight"
  lane :staging do
    # setup_ci() is useful in CI/CD (e.g., GitHub Actions) to disable prompts and configure environment
    # On local machine, you can safely comment it out
    setup_ci()

     # Use the API key for authentication
    app_store_connect_api_key( 
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],            # Replace with your actual Key ID
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],      # Replace with your actual Issuer ID
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    )

    # Ensure the app exists on App Store Connect (will create it if not found)
    # create_app_online(
    #   username:ENV["MATCH_USERNAME"],
    #   app_identifier: ENV["APP_STORE_APP_IDENTIFIER"],
    #   app_name: ENV["APP_NAME"],
    #   language: "English",
    #   sku: "SKU#{Time.now.to_i}", 
    #   itc_team_name: ENV["ITC_TEAM_NAME"],
    #   # skip_itc: true, # skip creation on App Store Connect if not needed
    #   enable_services: {push_notification: "on"}
    # )

    setup_keychain

    match(
      type: "appstore",
      readonly: true,
      keychain_name: $keychain_name,
      keychain_password: $keychain_password,
    )  # Ensure the certificates and provisioning profiles are available

    latest_build_number = latest_testflight_build_number(
      app_identifier: ENV["APP_STORE_APP_IDENTIFIER"] # Replace with your actual app identifier
    )
    increment_build_number(build_number: latest_build_number + 1)

    build_app(
      include_bitcode: true,
      workspace: "Runner.xcworkspace",
      scheme: ENV["SCHEME"],
      export_options: {
          method: "app-store",
          provisioningProfiles: {
            ENV["APP_STORE_APP_IDENTIFIER"] => "match AppStore #{ENV["APP_STORE_APP_IDENTIFIER"]}"
          }
      }
    ) 
    upload_staging_to_test_flight
    # upload_to_testflight(skip_waiting_for_build_processing: true)
  end

  private_lane :upload_staging_to_test_flight do 
     upload_to_testflight(
          # skip_waiting_for_build_processing: true,
          username: ENV["MATCH_USERNAME"],
          app_identifier: ENV["APP_STORE_APP_IDENTIFIER"],
          notify_external_testers: false,
          # beta_app_review_info: {
          #   contact_email: "email@email.com",
          #   contact_first_name: "Connect",
          #   contact_last_name: "API",
          #   contact_phone: "5558675309",
          #   demo_account_name: "demo@email.com",
          #   demo_account_password: "connectapi",
          #   notes: "this is review note for the reviewer <3 thank you for reviewing"
          # },
          # localized_app_info: {
          #   "default": {
          #     feedback_email: "default@email.com",
          #     marketing_url: "https://example.com/marketing-default",
          #     privacy_policy_url: "https://example.com/privacy-default",
          #     description: "Default description",
          #   },
            # "en-GB": {
            #   feedback_email: "en-gb@email.com",
            #   marketing_url: "https://example.com/marketing-en-gb",
            #   privacy_policy_url: "https://example.com/privacy-en-gb",
            #   description: "en-gb description",
            # }
          # },
          localized_build_info: {
            "default": {
              whats_new: "Default changelog",
            },
            "en-GB": {
              whats_new: "en-gb changelog",
            }
          }
        )
  end
  
end
