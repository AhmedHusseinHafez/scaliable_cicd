name: Flutter PR Review with Gemini

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.dart'
      - 'pubspec.yaml'
      - 'analysis_options.yaml'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  flutter-analysis:
    name: Flutter Static Analysis
    runs-on: ubuntu-latest
    outputs:
      analysis-report: ${{ steps.analyze.outputs.report }}
      test-coverage: ${{ steps.test.outputs.coverage }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Verify formatting
        id: format
        run: |
          dart format --set-exit-if-changed . > format_report.txt 2>&1 || echo "format_issues=true" >> $GITHUB_OUTPUT
          cat format_report.txt

      - name: Run Flutter Analyze
        id: analyze
        run: |
          flutter analyze --no-fatal-infos > analysis_report.txt 2>&1 || true
          cat analysis_report.txt
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat analysis_report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run tests with coverage
        id: test
        run: |
          flutter test --coverage --reporter expanded > test_report.txt 2>&1 || echo "test_failures=true" >> $GITHUB_OUTPUT
          if [ -f coverage/lcov.info ]; then
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}')
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          fi
          cat test_report.txt

      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-reports
          path: |
            analysis_report.txt
            test_report.txt
            format_report.txt
            coverage/
          retention-days: 30

  gemini-code-review:
    name: Gemini AI Code Review
    runs-on: ubuntu-latest
    needs: flutter-analysis
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.dart$' || echo "")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download analysis reports
        uses: actions/download-artifact@v4
        with:
          name: flutter-reports

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Install Gemini CLI
        run: |
          # Install gcloud gemini CLI (adjust based on actual CLI availability)
          gcloud components install alpha --quiet
          
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Prepare review context
        id: prep-context
        run: |
          cat > review_context.txt <<EOF
          # Flutter PR Code Review Request
          
          ## Repository: ${{ github.repository }}
          ## PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          ## Author: ${{ github.event.pull_request.user.login }}
          
          ## PR Description:
          ${{ github.event.pull_request.body }}
          
          ## Static Analysis Results:
          \`\`\`
          $(cat analysis_report.txt)
          \`\`\`
          
          ## Test Results:
          \`\`\`
          $(cat test_report.txt)
          \`\`\`
          
          ## Format Check:
          \`\`\`
          $(cat format_report.txt)
          \`\`\`
          
          ## Changed Dart Files:
          EOF
          
          # Append changed files content
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "### File: $file" >> review_context.txt
              echo '```dart' >> review_context.txt
              cat "$file" >> review_context.txt
              echo '```' >> review_context.txt
              echo "" >> review_context.txt
            fi
          done <<< "${{ steps.changed-files.outputs.files }}"

      - name: Run Gemini Code Review
        id: gemini-review
        run: |
          REVIEW_PROMPT="You are a senior Flutter developer and DevOps engineer reviewing a pull request. 
          
          Analyze the provided code changes, static analysis results, and test outcomes. Provide:
          
          1. **Code Quality Assessment** (1-10 score)
          2. **Critical Issues**: Security vulnerabilities, performance bottlenecks, breaking changes
          3. **Flutter Best Practices**: Widget composition, state management, build method optimization
          4. **Architecture Review**: SOLID principles, separation of concerns, dependency injection
          5. **Testing Coverage**: Missing tests, edge cases, integration test suggestions
          6. **Performance Concerns**: Unnecessary rebuilds, memory leaks, blocking operations
          7. **Recommendations**: Specific improvements with code examples
          8. **Approval Status**: APPROVE, REQUEST_CHANGES, or COMMENT
          
          Be constructive, specific, and cite line numbers where applicable. Focus on Flutter-specific patterns."
          
          # Using gcloud AI Platform API (adjust based on actual Gemini CLI)
          gcloud ai generative-models generate-content \
            --model=gemini-1.5-pro \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --region=us-central1 \
            --prompt="$REVIEW_PROMPT" \
            --context-file=review_context.txt \
            --temperature=0.3 \
            --max-output-tokens=4096 \
            > gemini_review.md

      - name: Post Gemini Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('gemini_review.md', 'utf8');
            
            const body = `## ðŸ¤– Gemini AI Code Review
            
            ${review}
            
            ---
            *This review was generated by Gemini 1.5 Pro. Always verify AI suggestions with human expertise.*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Check review decision
        id: check-decision
        run: |
          if grep -q "APPROVE" gemini_review.md && grep -q "Code Quality Assessment.*[8-9]" gemini_review.md; then
            echo "decision=approved" >> $GITHUB_OUTPUT
          elif grep -q "REQUEST_CHANGES" gemini_review.md || grep -q "CRITICAL" gemini_review.md; then
            echo "decision=changes_requested" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "decision=commented" >> $GITHUB_OUTPUT
          fi

  security-scan:
    name: Security & Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Run dependency audit
        run: |
          flutter pub get
          dart pub audit > security_report.txt 2>&1 || true
          cat security_report.txt

      - name: Check for outdated dependencies
        run: |
          dart pub outdated > outdated_deps.txt 2>&1 || true
          cat outdated_deps.txt

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security_report.txt
            outdated_deps.txt

  build-validation:
    name: Build Validation (Android/iOS)
    runs-on: macos-latest
    strategy:
      matrix:
        platform: [android, ios]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Setup Java
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Xcode
        if: matrix.platform == 'ios'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get dependencies
        run: flutter pub get

      - name: Build ${{ matrix.platform }}
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            flutter build apk --debug --analyze-size > build_android.txt 2>&1
          else
            flutter build ios --debug --no-codesign --analyze-size > build_ios.txt 2>&1
          fi

      - name: Upload build reports
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ matrix.platform }}
          path: build_*.txt

  final-summary:
    name: Generate PR Summary
    runs-on: ubuntu-latest
    needs: [flutter-analysis, gemini-code-review, security-scan, build-validation]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create PR summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let summary = `## ðŸ“Š PR Validation Summary\n\n`;
            summary += `### âœ… Checks Completed\n\n`;
            summary += `- Flutter Analysis: ${{ needs.flutter-analysis.result }}\n`;
            summary += `- Gemini Review: ${{ needs.gemini-code-review.result }}\n`;
            summary += `- Security Scan: ${{ needs.security-scan.result }}\n`;
            summary += `- Build Validation: ${{ needs.build-validation.result }}\n\n`;
            
            summary += `### ðŸ“ˆ Metrics\n`;
            summary += `- Test Coverage: ${{ needs.flutter-analysis.outputs.test-coverage || 'N/A' }}\n`;
            summary += `- Changed Files: Check Gemini review for details\n\n`;
            
            summary += `**Action Required**: Review the Gemini AI feedback above and address any critical issues.\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });